<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - The Sims CV</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&display=swap');

        :root {
            --sim-green: #76ff03;
            --sim-green-dark: #64dd17;
            --sim-bg: #121212;
            --sim-panel: #1e1e1e;
            --sim-input: #2c2c2c;
            --sim-text: #e0e0e0;
            --danger: #ff5252;
        }

        body {
            font-family: 'Nunito', sans-serif;
            background-color: var(--sim-bg);
            color: var(--sim-text);
            margin: 0;
            padding: 20px;
        }

        /* Header Bar */
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #444;
        }

        .user-info {
            color: var(--sim-green);
            font-weight: bold;
        }

        .btn-logout {
            background: #444;
            color: white;
            border: none;
            padding: 5px 15px;
            border-radius: 5px;
            cursor: pointer;
        }

        .btn-logout:hover {
            background: var(--danger);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: var(--sim-panel);
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5);
        }

        h2 {
            border-bottom: 2px solid var(--sim-green);
            padding-bottom: 10px;
            margin-top: 30px;
            color: var(--sim-green);
        }

        h2:first-child {
            margin-top: 0;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .full-width {
            grid-column: span 2;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            font-size: 0.9rem;
        }

        input,
        textarea {
            width: 100%;
            background: var(--sim-input);
            border: 1px solid #444;
            color: white;
            padding: 10px;
            border-radius: 5px;
            box-sizing: border-box;
            font-family: inherit;
        }

        input:focus,
        textarea:focus {
            outline: none;
            border-color: var(--sim-green);
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        /* Dynamic Items Styling */
        .dynamic-list {
            margin-top: 15px;
        }

        .dynamic-item {
            background: #252525;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 3px solid var(--sim-blue);
            position: relative;
        }

        /* Project Specific Styles */
        .project-item {
            border-left-color: #ff9800;
        }

        /* Orange for projects to distinguish */
        .links-container {
            background: rgba(0, 0, 0, 0.2);
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            border: 1px dashed #555;
        }

        .link-row {
            display: flex;
            gap: 10px;
            margin-bottom: 5px;
        }

        .btn {
            background: var(--sim-green);
            color: #000;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            margin-top: 10px;
            display: inline-block;
        }

        .btn:hover {
            background: var(--sim-green-dark);
        }

        .btn-small {
            padding: 5px 10px;
            font-size: 0.8rem;
            margin-top: 5px;
        }

        .btn-remove {
            background: var(--danger);
            color: white;
            position: absolute;
            top: 10px;
            right: 10px;
            margin: 0;
        }

        .save-container {
            text-align: center;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #444;
        }

        .save-btn {
            font-size: 1.2rem;
            padding: 15px 40px;
            width: 100%;
            max-width: 300px;
        }

        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }

            .full-width {
                grid-column: span 1;
            }
        }
    </style>
</head>

<body>

    <!-- CEK LOGIN SCRIPT -->
    <script>
        if (localStorage.getItem('isLoggedIn') !== 'true') {
            window.location.href = "login.html";
        }
    </script>

    <div class="top-bar">
        <div class="user-info">Halo, <span id="display-username">Admin</span> ðŸ‘‹</div>
        <button class="btn-logout" onclick="logout()">LOGOUT</button>
    </div>

    <div class="container">
        <h1 style="text-align: center; color: var(--sim-green);">The Sims CV - Dashboard Admin</h1>
        <p style="text-align: center; color: #888;">Edit data di bawah ini, lalu klik Simpan.</p>

        <form id="cvForm" onsubmit="event.preventDefault();">

            <!-- SECTION 1: INFO DASAR -->
            <h2>1. Identitas Sim</h2>
            <div class="form-grid">
                <div class="full-width"><label>Nama Lengkap</label><input type="text" id="name"></div>
                <div><label>Job Title</label><input type="text" id="title"></div>
                <div><label>URL Foto Profil</label><input type="text" id="image"></div>
                <div class="full-width"><label>Bio Singkat</label><textarea id="bio"></textarea></div>
            </div>

            <!-- SECTION 2: CONTACT -->
            <h2>2. Kontak</h2>
            <div class="form-grid">
                <div><label>Email</label><input type="text" id="c_email"></div>
                <div><label>No HP</label><input type="text" id="c_phone"></div>
                <div><label>Lokasi</label><input type="text" id="c_location"></div>
                <div><label>LinkedIn</label><input type="text" id="c_linkedin"></div>
            </div>

            <!-- SECTION 3: TRAITS -->
            <h2>3. Traits (Sifat)</h2>
            <div class="dynamic-list" id="traits-list"></div>
            <button type="button" class="btn" onclick="addTraitRow()">+ Tambah Trait</button>

            <!-- SECTION 4: SKILLS -->
            <h2>4. Skills (Keahlian)</h2>
            <div class="dynamic-list" id="skills-list"></div>
            <button type="button" class="btn" onclick="addSkillRow()">+ Tambah Skill</button>

            <!-- SECTION 5: JOBS -->
            <h2>5. Riwayat Karir</h2>
            <div class="dynamic-list" id="jobs-list"></div>
            <button type="button" class="btn" onclick="addJobRow()">+ Tambah Pekerjaan</button>

            <!-- SECTION 6: PROJECTS (NEW SECTION) -->
            <h2>6. Projects Portfolio</h2>
            <div class="dynamic-list" id="projects-list"></div>
            <button type="button" class="btn" onclick="addProjectRow()">+ Tambah Project</button>

            <!-- SECTION 7: EDUCATION -->
            <h2>7. Pendidikan & Aspirasi</h2>
            <div class="form-grid">
                <div><label>Universitas / Sekolah</label><input type="text" id="edu_school"></div>
                <div><label>Gelar / Degree</label><input type="text" id="edu_degree"></div>
                <div class="full-width"><label>Aspirasi Utama</label><input type="text" id="edu_aspiration"></div>
            </div>

            <div class="save-container">
                <button type="button" class="btn save-btn" onclick="saveData()">SIMPAN KE FIREBASE</button>
                <div id="status-msg" style="margin-top: 10px; color: var(--sim-green);"></div>
            </div>
        </form>
    </div>

    <!-- FIREBASE SDK & LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDxqQOEuFjIR2W9-lrtAjaYsqPMHa8-6X4",
            authDomain: "jimmy-27ea1.firebaseapp.com",
            databaseURL: "https://jimmy-27ea1.firebaseio.com",
            projectId: "jimmy-27ea1",
            storageBucket: "jimmy-27ea1.appspot.com",
            messagingSenderId: "1053115589398",
            appId: "1:1053115589398:web:f8f300891ea3c2d81be637",
            measurementId: "G-0VV0WP7VZ3"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        window.logout = function () {
            localStorage.removeItem('isLoggedIn');
            localStorage.removeItem('userName');
            window.location.href = "login.html";
        }
        const userName = localStorage.getItem('userName');
        if (userName) document.getElementById('display-username').innerText = userName;

        // --- HELPER FUNCTIONS (Traits, Skills, Jobs) ---
        window.addTraitRow = function (icon = "", label = "") {
            const container = document.getElementById('traits-list');
            const div = document.createElement('div');
            div.className = 'dynamic-item';
            div.innerHTML = `
            <button type="button" class="btn btn-remove" onclick="this.parentElement.remove()">Hapus</button>
            <div class="form-grid">
                <div><label>Icon</label><input type="text" class="in-icon" value="${icon}"></div>
                <div><label>Nama Trait</label><input type="text" class="in-label" value="${label}"></div>
            </div>
        `;
            container.appendChild(div);
        }

        window.addSkillRow = function (name = "", level = 1) {
            const container = document.getElementById('skills-list');
            const div = document.createElement('div');
            div.className = 'dynamic-item';
            div.innerHTML = `
            <button type="button" class="btn btn-remove" onclick="this.parentElement.remove()">Hapus</button>
            <div class="form-grid">
                <div><label>Nama Skill</label><input type="text" class="in-name" value="${name}"></div>
                <div><label>Level (1-10)</label><input type="number" min="1" max="10" class="in-level" value="${level}"></div>
            </div>
        `;
            container.appendChild(div);
        }

        window.addJobRow = function (role = "", company = "", date = "", detailsArr = []) {
            const container = document.getElementById('jobs-list');
            const detailsText = Array.isArray(detailsArr) ? detailsArr.join('\n') : "";
            const div = document.createElement('div');
            div.className = 'dynamic-item';
            div.innerHTML = `
            <button type="button" class="btn btn-remove" onclick="this.parentElement.remove()">Hapus</button>
            <div class="form-grid">
                <div><label>Posisi</label><input type="text" class="in-role" value="${role}"></div>
                <div><label>Perusahaan</label><input type="text" class="in-company" value="${company}"></div>
                <div><label>Periode</label><input type="text" class="in-date" value="${date}"></div>
                <div class="full-width">
                    <label>Deskripsi (Pisahkan poin dengan Enter)</label>
                    <textarea class="in-details">${detailsText}</textarea>
                </div>
            </div>
        `;
            container.appendChild(div);
        }

        // --- NEW: PROJECT FUNCTIONS ---

        // Fungsi untuk menambah baris Link di dalam sebuah Project
        window.addLinkRow = function (btnElement) {
            // Cari container link terdekat dari tombol yang diklik
            const container = btnElement.parentElement.querySelector('.links-container');
            const div = document.createElement('div');
            div.className = 'link-row';
            div.innerHTML = `
            <input type="text" placeholder="Label (misal: Demo)" class="in-link-label">
            <input type="text" placeholder="URL Link" class="in-link-url">
        `;
            container.appendChild(div);
        }

        // Fungsi untuk menambahkan Project Card Baru
        window.addProjectRow = function (title = "", category = "", description = "", image = "", linksArr = []) {
            const container = document.getElementById('projects-list');
            const div = document.createElement('div');
            div.className = 'dynamic-item project-item';

            // Generate existing links HTML if loading data
            let linksHtml = '';
            if (linksArr && linksArr.length > 0) {
                linksArr.forEach(link => {
                    linksHtml += `
                    <div class="link-row">
                        <input type="text" placeholder="Label" class="in-link-label" value="${link.label}">
                        <input type="text" placeholder="URL" class="in-link-url" value="${link.url}">
                    </div>
                `;
                });
            }

            div.innerHTML = `
            <button type="button" class="btn btn-remove" onclick="this.parentElement.remove()">Hapus</button>
            <div class="form-grid">
                <div><label>Project Title</label><input type="text" class="in-p-title" value="${title}"></div>
                <div><label>Category</label><input type="text" class="in-p-category" value="${category}"></div>
                <div class="full-width"><label>Image URL</label><input type="text" class="in-p-image" value="${image}"></div>
                <div class="full-width">
                    <label>Description</label>
                    <textarea class="in-p-desc">${description}</textarea>
                </div>
            </div>
            
            <label style="margin-top:10px; color:#aaa; font-size:0.8rem;">Links (Demo, GitHub, etc):</label>
            <div class="links-container">
                ${linksHtml}
            </div>
            <button type="button" class="btn btn-small" onclick="addLinkRow(this)">+ Tambah Link</button>
        `;
            container.appendChild(div);
        }

        // --- LOAD DATA ---
        async function loadData() {
            const docRef = doc(db, "cv_data", "main_profile");
            const docSnap = await getDoc(docRef);

            if (docSnap.exists()) {
                const data = docSnap.data();
                document.getElementById('name').value = data.name || "";
                document.getElementById('title').value = data.title || "";
                document.getElementById('image').value = data.image || "";
                document.getElementById('bio').value = data.bio || "";

                if (data.contact) {
                    document.getElementById('c_email').value = data.contact.email || "";
                    document.getElementById('c_phone').value = data.contact.phone || "";
                    document.getElementById('c_location').value = data.contact.location || "";
                    document.getElementById('c_linkedin').value = data.contact.linkedin || "";
                }
                if (data.education) {
                    document.getElementById('edu_school').value = data.education.school || "";
                    document.getElementById('edu_degree').value = data.education.degree || "";
                    document.getElementById('edu_aspiration').value = data.education.aspiration || "";
                }

                // Load Lists
                document.getElementById('traits-list').innerHTML = '';
                if (data.traits) data.traits.forEach(t => addTraitRow(t.icon, t.label));

                document.getElementById('skills-list').innerHTML = '';
                if (data.skills) data.skills.forEach(s => addSkillRow(s.name, s.level));

                document.getElementById('jobs-list').innerHTML = '';
                if (data.jobs) data.jobs.forEach(j => addJobRow(j.role, j.company, j.date, j.details));

                // Load NEW Projects
                document.getElementById('projects-list').innerHTML = '';
                if (data.projects) {
                    data.projects.forEach(p => {
                        addProjectRow(p.title, p.category, p.description, p.image, p.links);
                    });
                }
            }
            // Add empty defaults if needed
            if (document.getElementById('projects-list').innerHTML === '') {
                addProjectRow();
            }
        }

        // --- SAVE DATA ---
        window.saveData = async function () {
            const statusMsg = document.getElementById('status-msg');
            statusMsg.innerText = "Menyimpan...";

            const newData = {
                name: document.getElementById('name').value,
                title: document.getElementById('title').value,
                image: document.getElementById('image').value,
                bio: document.getElementById('bio').value,
                contact: {
                    email: document.getElementById('c_email').value,
                    phone: document.getElementById('c_phone').value,
                    location: document.getElementById('c_location').value,
                    linkedin: document.getElementById('c_linkedin').value
                },
                education: {
                    school: document.getElementById('edu_school').value,
                    degree: document.getElementById('edu_degree').value,
                    aspiration: document.getElementById('edu_aspiration').value
                }
            };

            // Get Traits
            newData.traits = [];
            document.querySelectorAll('#traits-list .dynamic-item').forEach(item => {
                newData.traits.push({
                    icon: item.querySelector('.in-icon').value,
                    label: item.querySelector('.in-label').value
                });
            });

            // Get Skills
            newData.skills = [];
            document.querySelectorAll('#skills-list .dynamic-item').forEach(item => {
                let lvl = parseInt(item.querySelector('.in-level').value) || 1;
                newData.skills.push({
                    name: item.querySelector('.in-name').value,
                    level: lvl,
                    percentage: lvl * 10
                });
            });

            // Get Jobs
            newData.jobs = [];
            document.querySelectorAll('#jobs-list .dynamic-item').forEach(item => {
                const detailsRaw = item.querySelector('.in-details').value;
                const detailsArr = detailsRaw.split('\n').filter(line => line.trim() !== "");
                newData.jobs.push({
                    role: item.querySelector('.in-role').value,
                    company: item.querySelector('.in-company').value,
                    date: item.querySelector('.in-date').value,
                    details: detailsArr
                });
            });

            // --- NEW: Get Projects ---
            newData.projects = [];
            document.querySelectorAll('.project-item').forEach(item => {
                // Get nested links
                const linksArr = [];
                item.querySelectorAll('.link-row').forEach(lRow => {
                    const label = lRow.querySelector('.in-link-label').value;
                    const url = lRow.querySelector('.in-link-url').value;
                    if (label && url) {
                        linksArr.push({ label, url });
                    }
                });

                newData.projects.push({
                    title: item.querySelector('.in-p-title').value,
                    category: item.querySelector('.in-p-category').value,
                    image: item.querySelector('.in-p-image').value,
                    description: item.querySelector('.in-p-desc').value,
                    links: linksArr
                });
            });

            try {
                await setDoc(doc(db, "cv_data", "main_profile"), newData);
                statusMsg.innerText = "Berhasil Disimpan! âœ…";
                statusMsg.style.color = "var(--sim-green)";
                setTimeout(() => statusMsg.innerText = "", 3000);
            } catch (error) {
                console.error(error);
                statusMsg.innerText = "Gagal: " + error.message;
                statusMsg.style.color = "var(--danger)";
            }
        }

        loadData();
    </script>

</body>

</html>